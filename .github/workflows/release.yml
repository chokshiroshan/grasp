name: Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

jobs:
  create-release:
    name: Create Release
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Build web app
        working-directory: ./frontend
        run: npm run build

      - name: Create release archive
        run: |
          cd frontend/dist
          tar -czf ../../grasp-web-${{ github.ref_name }}.tar.gz .
          cd ../..
          zip -r grasp-web-${{ github.ref_name }}.zip frontend/dist

      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          release_name: Grasp ${{ github.ref_name }}
          draft: false
          prerelease: false
          body: |
            ## What's Changed

            See the [CHANGELOG](CHANGELOG.md) for details.

            ## Installation

            ### Web Application

            Grasp is now a web application. Download the build artifacts and deploy to any static hosting service:

            - **tar.gz**: `grasp-web-${{ github.ref_name }}.tar.gz`
            - **zip**: `grasp-web-${{ github.ref_name }}.zip`

            ### Deployment Options
            - Vercel, Netlify, or any static host
            - Nginx/Apache with the extracted files
            - Python: `python -m http.server` in the dist folder

            ### Backend Required
            The web app requires the Python backend to be running on `http://localhost:8000`.
            See the README for backend setup instructions.

      - name: Upload tar.gz
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./grasp-web-${{ github.ref_name }}.tar.gz
          asset_name: grasp-web-${{ github.ref_name }}.tar.gz
          asset_content_type: application/gzip

      - name: Upload zip
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./grasp-web-${{ github.ref_name }}.zip
          asset_name: grasp-web-${{ github.ref_name }}.zip
          asset_content_type: application/zip
